<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Pomodoro</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            text-align: center;
            padding: 40px 20px;
            background: var(--bg-color);
            color: var(--text-color);
        }
        #time {
            font-size: 3em;
            margin: 40px 0 20px;
            font-weight: bold;
        }
        .bar {
            height: 14px;
            background: var(--hint-color);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0 30px;
        }
        .fill {
            height: 100%;
            width: 100%;
            background: var(--accent-color);
            transition: width 1s linear;
        }
    </style>
</head>
<body>
<div id="time">--:--</div>
<div class="bar"><div class="fill" id="fill"></div></div>

<script>
    const tg = Telegram.WebApp;
    tg.expand(); // full height

    // Apply Telegram theme colors
    const theme = tg.themeParams;
    document.body.style.setProperty("--bg-color", theme.bg_color || "#ffffff");
    document.body.style.setProperty("--text-color", theme.text_color || "#000000");
    document.body.style.setProperty("--hint-color", theme.hint_color || "#cccccc");
    document.body.style.setProperty("--accent-color", theme.button_color || "tomato");

    // Parse start and end times from URL (in seconds since epoch)
    const urlParams = new URLSearchParams(window.location.search);
    const startParam = urlParams.get("start");
    const start = startParam ? parseInt(startParam, 10) * 1000 : Date.now();
    const end = parseInt(urlParams.get("end"), 10) * 1000;
    const total = Math.max(0, end - start); // Ensure total is non-negative

    function update() {
        const now = Date.now();
        let remaining;
        if (now < start) {
            remaining = total;
        } else if (now > end) {
            remaining = 0;
        } else {
            remaining = end - now;
        }

        const mins = String(Math.floor(remaining / 60000)).padStart(2, "0");
        const secs = String(Math.floor((remaining % 60000) / 1000)).padStart(2, "0");
        document.getElementById("time").textContent = `${mins}:${secs}`;

        document.getElementById("fill").style.width = `${(total > 0 ? (remaining / total) * 100 : 0)}%`;

        if (remaining <= 0) {
            clearInterval(timer);
            document.getElementById("time").textContent = "00:00";
            tg.MainButton.setText("✅ Finished");
            tg.MainButton.show();
        }
    }

    // ✅ Native Main Button ("Done")
    tg.MainButton.setText("✅ Done");
    tg.MainButton.onClick(() => tg.sendData("done"));
    tg.MainButton.show();

    // ⬅️ Native Back Button
    tg.BackButton.onClick(() => tg.close());
    tg.BackButton.show();

    const timer = setInterval(update, 1000);
    update();
</script>
</body>
</html>